#{% extends "xadmin/base_site.html" %}

{% load staticfiles  %}
{% load static %}

{% block content %}

    <p>Scan Track_code then item_code </p>
    <form id="item" action="/scanpackageitem/" method="post">
<!--
        Track_code: <input type="text" id="track_code" autofocus> <br>
        <br>
   -->
        item_code  : <input type="text"   id="item_code" > <br>
        <button type="button" id='get_packageitem_info'>submit</button>
        <p>Track_code: <span id='ret_track_code' style="font-size:30px"></span></p>
        <table id="Package" cellpadding="1" cellspacing="0" border="1" class="item_info" border="1px" width="100%">
            <caption align="top"><h3>Track_code: <span id='Track_code'></span></h3></caption>
            <thead>
            <tr>
                <th>sku</th>
                <th>name</th>
                <th>quantity</th>
                <th>barcode</th>
                <th>real_quantity</th>
                <th>action</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
        <h3>js自动生成条形码插件-JsBarcode</h3>
        <div id="box">
            <img id="barcode" />
        </div>

        {% csrf_token %}
    </form>


<div id="printBtn">
         <table>
             <tr>
                 <td>test</td>
             </tr>
         </table>
    </div>
    <input type="button" onclick="print()" value="打印" />

    <script type="text/javascript" src="{% static "js/jquery.print.js" %}"></script>

    <script src="https://cdn.bootcss.com/jsbarcode/3.8.0/JsBarcode.all.min.js"></script>



    </script>

    <script>
    // using jQuery
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    var csrftoken = getCookie('csrftoken');

    function csrfSafeMethod(method) {
        // 这些HTTP方法不要求CSRF包含
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    $(document).keyup(function (event) {
        if (event.keyCode === 13) {
            $("#get_packageitem_info").trigger("click");
        }
    });


    //这里是关键点 .ready 函数好像监听器。
    $(document).ready(function () {



        $("#get_packageitem_info").click(function () {

            //var track_code = $("#track_code").val();
                var item_code = $("#item_code").val();

                alert_text = '请稍等,正在查询:' + item_code + '信息';
                alert(alert_text);
                $.ajax({
                    type: 'POST',

                    url: "/scanpackageitem/",
                    data: {


                        //track_code: track_code,
                        item_code: item_code,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function (data) {
                        console.log("scanpackageitem", data);
                        if (data.track_code == "Not Found!"){
                            $("#ret_track_code").css("backgroundColor", "red");
                            $("#ret_order_no").css("backgroundColor", "red");
                        }
                        else{
                            $("#ret_track_code").css("backgroundColor", "yellow");
                            $("#ret_order_no").css("backgroundColor", "yellow");
                        }
                        $("#ret_track_code").html(data.track_code);
                        $("#ret_order_no").html(data.order_no);
                        //$("#track_code").val("");
                        $("#item_code").val("");
                        test(data.barcode);
                        $("#box").jqprint();



                    }
                });
         });






        });
      function  test(barcode_toprint){

     var barcode = document.getElementById('barcode'),

     options = {
         format:"CODE128",
         displayValue:true,
         fontSize:18,
         width: 1,//较细处条形码的宽度
         height:20
     };
     JsBarcode(barcode, barcode_toprint, options);//原生
      }

    function print(){
        /*
71         var img = document.getElementById("barcode"); /// get image element
72         var canvas  = document.getElementsByTagName("canvas")[0];  /// get canvas element
73         img.src = canvas.toDataURL();                     /// update image
74
75         $("#image").jqprint({
76             debug:false,
77             importCSS:true,
78             printContainer:true,
79             operaSupport:false
80         });
*/
        $("#box").jqprint({
	     debug: false, //如果是true则可以显示iframe查看效果（iframe默认高和宽都很小，可以再源码中调大），默认是false
	     importCSS: true, //true表示引进原来的页面的css，默认是true。（如果是true，先会找$("link[media=print]")，若没有会去找$("link")中的css文件）
	     printContainer: true, //表示如果原来选择的对象必须被纳入打印（注意：设置为false可能会打破你的CSS规则）。
	     operaSupport: true//表示如果插件也必须支持歌opera浏览器，在这种情况下，它提供了建立一个临时的打印选项卡。默认是true
		});


81     }

    </script>

    <script language="javascript">
    function print() {
         $("#printBtn").print();
    }
</script>


{% endblock %}